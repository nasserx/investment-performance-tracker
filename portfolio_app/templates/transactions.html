{% extends "base.html" %}

{% block title %}Transactions - Investment Portfolio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Transactions</h1>
            {% if funds|length > 0 %}
                <button type="button" class="btn btn-primary" onclick="openAddAssetModal()">
                    Add Symbol
                </button>
            {% else %}
                <a class="btn btn-primary" href="{{ url_for('funds.funds_list') }}">
                    Add funds first
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-4">
        <form method="GET" action="{{ url_for('transactions.transaction_list') }}">
            <div class="input-group">
                <select class="form-select" name="category" onchange="this.form.submit()">
                    <option value="">All asset categories</option>
                    {% for fund in funds %}
                    <option value="{{ fund.category }}" {% if selected_category == fund.category %}selected{% endif %}>
                        {{ fund.category }}
                    </option>
                    {% endfor %}
                </select>
                {% if selected_category %}
                <a href="{{ url_for('transactions.transaction_list') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Transactions by Symbol -->
<div class="row">
    <div class="col-12">
        {% if symbol_data|length > 0 %}
            {% for item in symbol_data %}
            <div class="card border-0 shadow-sm mb-3">
                 <div class="card-header bg-white border-bottom py-2 px-3 category-header page-accent-surface"
                     onclick="toggleSymbolTransactions('{{ item.group_id }}')">
                    <div class="row align-items-center g-1 summary-row">
                        <div class="col-lg-2 col-md-3 d-flex align-items-center gap-2">
                            <i class="bi bi-chevron-right category-chevron" id="chevron-{{ item.group_id }}"></i>
                            <span class="fw-bold text-dark">{{ item.symbol }}</span>
                            <span class="badge bg-light text-dark border">{{ item.fund.category }}</span>
                        </div>
                        <div class="col-lg-8 col-md-7">
                            <div class="category-summary columns-5">
                                <div class="summary-item">
                                    <div class="summary-label">Transactions</div>
                                    <div class="summary-value">{{ item.summary.transaction_count }}</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Total Spent</div>
                                    <div class="summary-value">{{ item.summary.total_buy_cost|fmt_money }}</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Holdings</div>
                                    <div class="summary-value">{{ item.summary.total_quantity_held|fmt_decimal }}</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Avg Cost</div>
                                    <div class="summary-value text-info-emphasis">{{ item.summary.average_cost|fmt_money(item.avg_cost_decimals) }}</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Realized P&amp;L</div>
                                    <div class="summary-value {% if item.summary.realized_pnl >= 0 %}profit{% else %}loss{% endif %}">
                                        {% if item.summary.realized_pnl >= 0 %}+{% endif %}{{ item.summary.realized_pnl|fmt_money }}
                                    </div>
                                    <div class="summary-value summary-subvalue {% if item.summary.roi_percent is not none and item.summary.roi_percent >= 0 %}profit{% elif item.summary.roi_percent is not none and item.summary.roi_percent < 0 %}loss{% else %}neutral{% endif %}">
                                        {{ item.summary.roi_percent_display }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-2 text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button"
                                        class="btn btn-outline-primary add-transaction-icon-btn js-add-transaction-btn"
                                        data-fund-id="{{ item.fund.id }}"
                                        data-category="{{ item.fund.category|e }}"
                                        data-symbol="{{ item.symbol|e }}"
                                        title="Add Transaction"
                                        aria-label="Add Transaction"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger js-delete-symbol-btn"
                                        data-fund-id="{{ item.fund.id }}"
                                        data-category="{{ item.fund.category|e }}"
                                        data-symbol="{{ item.symbol|e }}"
                                        data-tx-count="{{ item.summary.transaction_count or 0 }}"
                                        title="Delete Symbol"
                                        aria-label="Delete Symbol"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="category-transactions" id="transactions-{{ item.group_id }}" style="display: none;">
                    {% if item.transactions|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0 transactions-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="small" style="width: 110px;">Date</th>
                                    <th class="small" style="width: 90px;">Type</th>
                                    <th class="small" style="width: 90px;">Symbol</th>
                                    <th class="small text-end" style="width: 120px;">Price</th>
                                    <th class="small text-end" style="width: 90px;">Qty</th>
                                    <th class="small text-end" style="width: 90px;">Fees</th>
                                    <th class="small text-end" style="width: 140px;">Total</th>
                                    <th class="small text-center" style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in item.transactions %}
                                <tr>
                                    <td><small class="text-muted">{{ transaction.date_short }}</small></td>
                                    <td>
                                        {% if transaction.transaction_type == 'Buy' %}
                                            <span class="badge bg-success"><i class="bi bi-arrow-down"></i> Buy</span>
                                        {% else %}
                                            <span class="badge bg-danger"><i class="bi bi-arrow-up"></i> Sell</span>
                                        {% endif %}
                                    </td>
                                    <td><small class="text-uppercase">{{ transaction.symbol or '-' }}</small></td>
                                    <td class="text-end"><small>{{ transaction.price|fmt_money(item.price_decimals) }}</small></td>
                                    <td class="text-end"><small>{{ transaction.quantity|fmt_decimal }}</small></td>
                                    <td class="text-end"><small class="text-danger">{{ transaction.fees|fmt_money }}</small></td>
                                    <td class="text-end"><small class="text-primary">{{ transaction.total_cost|fmt_money }}</small></td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm js-edit-transaction-btn"
                                                    data-tx='{{ {
                                                        "id": transaction.id,
                                                        "fundId": transaction.fund_id,
                                                        "type": transaction.transaction_type,
                                                        "symbol": (transaction.symbol or ""),
                                                        "price": (transaction.price ~ ""),
                                                        "quantity": (transaction.quantity ~ ""),
                                                        "fees": (transaction.fees ~ ""),
                                                        "notes": (transaction.notes or ""),
                                                        "dateShort": transaction.date_short
                                                    }|tojson|e }}'
                                                    title="Edit"
                                                    aria-label="Edit"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm js-delete-transaction-btn"
                                                    data-tx-id="{{ transaction.id }}"
                                                    title="Delete"
                                                    aria-label="Delete"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-3 text-muted text-center bg-light help-message">
                        <small><i class="bi bi-info-circle"></i> No transactions for this symbol yet</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i>
                    No symbols yet. Click Add Symbol then add transactions.
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Symbol Modal -->
<div class="modal fade" id="addAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('transactions.asset_add') }}" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Symbol</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="asset_fund_id" class="form-label">Asset Category</label>
                                {% set _asset_errs = (form_errors.get('asset_add', {}) if form_errors else {}) %}
                                {% set _asset_vals = (form_values.get('asset_add', {}) if form_values else {}) %}
                                <select class="form-select {% if _asset_errs.get('asset_fund_id') %}is-invalid{% endif %}" id="asset_fund_id" name="asset_fund_id">
                                    <option value="">Select asset category...</option>
                                    {% for fund in funds %}
                                    <option value="{{ fund.id }}" {% if (_asset_vals.get('asset_fund_id') and _asset_vals.get('asset_fund_id')|int == fund.id) or (not _asset_vals.get('asset_fund_id') and selected_category == fund.category) %}selected{% endif %}>
                                        {{ fund.category }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if _asset_errs.get('asset_fund_id') %}
                                <div class="invalid-feedback">{{ _asset_errs.get('asset_fund_id') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="asset_symbol" class="form-label">Symbol</label>
                                    <input type="text" class="form-control {% if _asset_errs.get('asset_symbol') %}is-invalid{% endif %}" id="asset_symbol" name="asset_symbol" maxlength="20"
                                       placeholder="e.g., AAPL" oninput="this.value = this.value.toUpperCase();">
                                {% if _asset_errs.get('asset_symbol') %}
                                <div class="invalid-feedback">{{ _asset_errs.get('asset_symbol') }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i>
                        Then use Add Transaction to add buys and sells.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('transactions.transaction_add') }}" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="add_tx_modal_title">Add Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% set _tx_add_errs = (form_errors.get('transaction_add', {}) if form_errors else {}) %}
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="mb-3" id="add_tx_category_group">
                                <label for="fund_id" class="form-label">Asset Category</label>
                                {% set _tx_add_vals = (form_values.get('transaction_add', {}) if form_values else {}) %}
                                <select class="form-select {% if _tx_add_errs.get('fund_id') %}is-invalid{% endif %}" id="fund_id" name="fund_id">
                                    <option value="">Select asset category...</option>
                                    {% for fund in funds %}
                                    <option value="{{ fund.id }}">{{ fund.category }}</option>
                                    {% endfor %}
                                </select>
                                {% if _tx_add_errs.get('fund_id') %}
                                <div class="invalid-feedback">{{ _tx_add_errs.get('fund_id') }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3" id="add_tx_symbol_group">
                                <label for="symbol" class="form-label">Symbol</label>
                                    <input type="text" class="form-control {% if _tx_add_errs.get('symbol') %}is-invalid{% endif %}" id="symbol" name="symbol" maxlength="20"
                                       placeholder="e.g., AAPL" oninput="this.value = this.value.toUpperCase();">
                                {% if _tx_add_errs.get('symbol') %}
                                <div class="invalid-feedback">{{ _tx_add_errs.get('symbol') }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="add_tx_type_group">
                        <label for="transaction_type" class="form-label visually-hidden">Transaction Type</label>
                        <div class="row g-2">
                            <div class="col-6 d-grid">
                                <button type="button" class="btn btn-buy" id="add_tx_type_buy_btn" aria-label="Buy">
                                    Buy
                                </button>
                            </div>
                            <div class="col-6 d-grid">
                                <button type="button" class="btn btn-sell" id="add_tx_type_sell_btn" aria-label="Sell">
                                    Sell
                                </button>
                            </div>
                        </div>

                        <!-- Keep the original select for form submission + existing JS wiring (hidden). -->
                        <select class="form-select visually-hidden {% if _tx_add_errs.get('transaction_type') %}is-invalid{% endif %}" id="transaction_type" name="transaction_type" tabindex="-1" aria-hidden="true">
                            <option value="" selected></option>
                            <option value="Buy">Buy</option>
                            <option value="Sell">Sell</option>
                        </select>

                        {% if _tx_add_errs.get('transaction_type') %}
                        <div class="invalid-feedback">{{ _tx_add_errs.get('transaction_type') }}</div>
                        {% endif %}
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">Price (per unit)</label>
                                <input type="text" inputmode="decimal" class="form-control {% if _tx_add_errs.get('price') %}is-invalid{% endif %}" id="price" name="price"
                                    placeholder="0.0000">
                                {% if _tx_add_errs.get('price') %}
                                <div class="invalid-feedback">{{ _tx_add_errs.get('price') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <div class="position-relative">
                                    <input type="text" inputmode="decimal" class="form-control {% if _tx_add_errs.get('quantity') %}is-invalid{% endif %} pe-5" id="quantity" name="quantity"
                                        placeholder="0.0000">
                                    <span id="add_sell_max_row" class="d-none sell-max-inline">
                                        <button type="button" class="btn btn-link btn-sm p-0 sell-max-btn" id="add_sell_max_btn">Max</button>
                                    </span>
                                </div>
                                {% if _tx_add_errs.get('quantity') %}
                                <div class="invalid-feedback">{{ _tx_add_errs.get('quantity') }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="fees" class="form-label">Fees (Optional)</label>
                           <input type="text" inputmode="decimal" class="form-control {% if _tx_add_errs.get('fees') %}is-invalid{% endif %}" id="fees" name="fees"
                               value="0" placeholder="0.00">
                        {% if _tx_add_errs.get('fees') %}
                        <div class="invalid-feedback">{{ _tx_add_errs.get('fees') }}</div>
                        {% endif %}
                        <div id="total_cost_preview" class="tx-preview"></div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="add_tx_submit_btn">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form method="POST" id="editTransactionForm" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% set _tx_edit_errs = (form_errors.get('transaction_edit', {}) if form_errors else {}) %}
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_fund_id_display" class="form-label">Asset Category</label>
                                <select class="form-select" id="edit_fund_id_display" disabled>
                                    <option value="">Select asset category...</option>
                                    {% for fund in funds %}
                                    <option value="{{ fund.id }}">{{ fund.category }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_symbol" class="form-label">Symbol</label>
                                <input type="text" class="form-control" id="edit_symbol" name="edit_symbol" maxlength="20" readonly
                                       placeholder="e.g., AAPL">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_transaction_type_display" class="form-label">Transaction Type</label>
                        <select class="form-select" id="edit_transaction_type_display" disabled>
                            <option value="">Select type...</option>
                            <option value="Buy">Buy</option>
                            <option value="Sell">Sell</option>
                        </select>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_price" class="form-label">Price (per unit)</label>
                                {% set _tx_edit_errs = (form_errors.get('transaction_edit', {}) if form_errors else {}) %}
                                {% set _tx_edit_vals = (form_values.get('transaction_edit', {}) if form_values else {}) %}
                                <input type="text" inputmode="decimal" class="form-control {% if _tx_edit_errs.get('edit_price') %}is-invalid{% endif %}" id="edit_price" name="edit_price"
                                    placeholder="0.0000">
                                {% if _tx_edit_errs.get('edit_price') %}
                                <div class="invalid-feedback">{{ _tx_edit_errs.get('edit_price') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_quantity" class="form-label">Quantity</label>
                                <input type="text" inputmode="decimal" class="form-control {% if _tx_edit_errs.get('edit_quantity') %}is-invalid{% endif %}" id="edit_quantity" name="edit_quantity"
                                    placeholder="0.0000">
                                {% if _tx_edit_errs.get('edit_quantity') %}
                                <div class="invalid-feedback">{{ _tx_edit_errs.get('edit_quantity') }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_fees" class="form-label">Fees (Optional)</label>
                                                <input type="text" inputmode="decimal" class="form-control {% if _tx_edit_errs.get('edit_fees') %}is-invalid{% endif %}" id="edit_fees" name="edit_fees"
                                                    placeholder="0.00">
                                {% if _tx_edit_errs.get('edit_fees') %}
                                <div class="invalid-feedback">{{ _tx_edit_errs.get('edit_fees') }}</div>
                                {% endif %}
                                <div id="edit_total_cost_preview" class="tx-preview"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_date" class="form-label">Date</label>
                                <input type="text" class="form-control {% if _tx_edit_errs.get('edit_date') %}is-invalid{% endif %}" id="edit_date" name="edit_date" placeholder="YYYY-MM-DD">
                                {% if _tx_edit_errs.get('edit_date') %}
                                <div class="invalid-feedback">{{ _tx_edit_errs.get('edit_date') }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="edit_notes" name="edit_notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Transaction Modal -->
<div class="modal fade" id="deleteTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="deleteTransactionForm" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Delete this transaction?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        This will recalculate average costs for this symbol.
                    </div>
                    <div id="delete_tx_error" class="alert alert-danger d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Symbol Modal -->
<div class="modal fade" id="deleteAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="deleteAssetForm" action="{{ url_for('transactions.asset_delete') }}" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="delete_asset_fund_id" id="delete_asset_fund_id">
                <input type="hidden" name="delete_asset_symbol" id="delete_asset_symbol">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Delete this symbol?</p>
                    <div class="alert alert-warning mb-2">
                        <i class="bi bi-exclamation-triangle"></i>
                        This will delete all transactions for this symbol.
                    </div>
                    <div id="delete_asset_error" class="alert alert-danger d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script>
function ensureEditDatePicker() {
    const el = document.getElementById('edit_date');
    if (!el) return;

    // Avoid re-initialization if modal opened multiple times.
    if (el._flatpickr) return;
    if (!window.flatpickr) return;

    window.flatpickr(el, {
        dateFormat: 'Y-m-d',
        allowInput: true,
    });
}

function openAddAssetModal() {
    const modalEl = document.getElementById('addAssetModal');
    const symbolInput = document.getElementById('asset_symbol');
    if (symbolInput) symbolInput.value = '';
    new bootstrap.Modal(modalEl).show();
}


// Re-open modals after server-side validation errors and restore field values.
(function reopenModalFromServerErrors() {
    const which = {{ (open_modal or '') | tojson }};
    const payload = {{ (open_modal_payload or {}) | tojson }};

    if (!which) return;

    document.addEventListener('DOMContentLoaded', function() {
        try {
            if (which === 'addAssetModal') {
                openAddAssetModal();
                const fundVal = {{ (form_values.get('asset_add', {}).get('asset_fund_id', '') if form_values else '') | tojson }};
                const symVal = {{ (form_values.get('asset_add', {}).get('asset_symbol', '') if form_values else '') | tojson }};
                const fundEl = document.getElementById('asset_fund_id');
                const symEl = document.getElementById('asset_symbol');
                if (fundEl && fundVal) fundEl.value = String(fundVal);
                if (symEl && symVal) symEl.value = String(symVal);
            }

            if (which === 'addTransactionModal') {
                const vals = {{ (form_values.get('transaction_add', {}) if form_values else {}) | tojson }};

                const fundEl = document.getElementById('fund_id');
                const symEl = document.getElementById('symbol');
                const typeEl = document.getElementById('transaction_type');
                const priceEl = document.getElementById('price');
                const qtyEl = document.getElementById('quantity');
                const feesEl = document.getElementById('fees');
                const notesEl = document.getElementById('notes');

                if (fundEl && vals.fund_id) fundEl.value = String(vals.fund_id);
                if (symEl && vals.symbol) symEl.value = String(vals.symbol).toUpperCase();
                if (typeEl && vals.transaction_type) {
                    typeEl.value = String(vals.transaction_type);
                    typeEl.dispatchEvent(new Event('change'));
                }
                if (priceEl && vals.price != null) priceEl.value = String(vals.price);
                if (qtyEl && vals.quantity != null) qtyEl.value = String(vals.quantity);
                if (feesEl && vals.fees != null && String(vals.fees) !== '') feesEl.value = String(vals.fees);
                if (notesEl && vals.notes != null) notesEl.value = String(vals.notes);

                if (priceEl) priceEl.dispatchEvent(new Event('input'));
                if (qtyEl) qtyEl.dispatchEvent(new Event('input'));
                if (feesEl) feesEl.dispatchEvent(new Event('input'));

                // Preserve the locked layout when the modal was opened from a symbol row.
                const categoryGroup = document.getElementById('add_tx_category_group');
                const symbolGroup = document.getElementById('add_tx_symbol_group');
                const context = document.getElementById('add_tx_context');
                const contextValue = document.getElementById('add_tx_context_value');
                const locked = Boolean(vals.fund_id) && Boolean(vals.symbol);

                if (categoryGroup) categoryGroup.classList.toggle('d-none', locked);
                if (symbolGroup) symbolGroup.classList.toggle('d-none', locked);
                if (context) context.classList.toggle('d-none', !locked);
                if (contextValue) {
                    if (locked && fundEl && fundEl.selectedOptions && fundEl.selectedOptions[0]) {
                        const catText = fundEl.selectedOptions[0].text || 'Asset Category';
                        const symText = String(vals.symbol || '').toUpperCase();
                        contextValue.textContent = symText ? `${catText}/${symText}` : catText;
                    } else {
                        contextValue.textContent = '';
                    }
                }

                const modalEl = document.getElementById('addTransactionModal');
                if (modalEl) new bootstrap.Modal(modalEl).show();
            }

            if (which === 'deleteTransactionModal' && payload && payload.tx_id) {
                deleteTransaction(payload.tx_id);
            }

            if (which === 'deleteAssetModal') {
                const fundId = payload && payload.fund_id ? payload.fund_id : '';
                const symbol = payload && payload.symbol ? payload.symbol : '';
                const category = payload && payload.category ? payload.category : '';

                const fundInput = document.getElementById('delete_asset_fund_id');
                const symbolInput = document.getElementById('delete_asset_symbol');
                const context = document.getElementById('delete_asset_context');

                if (fundInput) fundInput.value = fundId ? String(fundId) : '';
                if (symbolInput) symbolInput.value = (symbol || '').toUpperCase();
                if (context) {
                    const catText = category ? String(category).toUpperCase() : 'ASSET CATEGORY';
                    const symText = (symbol || '').toUpperCase();
                    context.textContent = symText ? `${catText}/${symText}` : catText;
                }

                new bootstrap.Modal(document.getElementById('deleteAssetModal')).show();
            }

            if (which === 'editTransactionModal' && payload && payload.id) {
                const vals = {{ (form_values.get('transaction_edit', {}) if form_values else {}) | tojson }};
                editTransaction(
                    payload.id,
                    payload.fund_id,
                    payload.type,
                    payload.symbol,
                    vals.edit_price,
                    vals.edit_quantity,
                    vals.edit_fees,
                    vals.edit_notes,
                    vals.edit_date,
                );
            }
        } catch (e) {
            // noop
        }
    });
})();
function toggleSymbolTransactions(groupId) {
    const transactionsDiv = document.getElementById(`transactions-${groupId}`);
    const chevron = document.getElementById(`chevron-${groupId}`);
    if (!transactionsDiv || !chevron) return;

    if (transactionsDiv.style.display === 'none') {
        transactionsDiv.style.display = 'block';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
    } else {
        transactionsDiv.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
    }
}

function openAddTransactionModal(fundId, categoryName, symbol, forcedType) {
    const modalEl = document.getElementById('addTransactionModal');
    const categoryGroup = document.getElementById('add_tx_category_group');
    const symbolGroup = document.getElementById('add_tx_symbol_group');
    const typeGroup = document.getElementById('add_tx_type_group');
    const context = document.getElementById('add_tx_context');
    const contextValue = document.getElementById('add_tx_context_value');

    const titleEl = document.getElementById('add_tx_modal_title');
    const submitBtn = document.getElementById('add_tx_submit_btn');

    const fundSelect = document.getElementById('fund_id');
    const symbolInput = document.getElementById('symbol');
    const typeSelect = document.getElementById('transaction_type');
    const priceInput = document.getElementById('price');
    const quantityInput = document.getElementById('quantity');
    const feesInput = document.getElementById('fees');
    const notesInput = document.getElementById('notes');

    if (fundId) {
        fundSelect.value = fundId;
    } else {
        fundSelect.value = '';
    }

    symbolInput.value = symbol ? (symbol || '').toUpperCase() : '';

    if (priceInput) priceInput.value = '';
    if (quantityInput) quantityInput.value = '';
    if (feesInput) feesInput.value = '0';
    if (notesInput) notesInput.value = '';

    if (forcedType && typeSelect) {
        typeSelect.value = forcedType;
        if (typeGroup) typeGroup.classList.add('d-none');
        if (titleEl) {
            const isNewInvestment = (forcedType === 'Buy') && !fundId && !symbol;
            titleEl.textContent = isNewInvestment ? 'New Investment' : ((forcedType === 'Buy') ? 'Add Buy' : 'Add Transaction');
        }
        if (submitBtn) submitBtn.textContent = (forcedType === 'Buy') ? 'Add' : 'Add Transaction';
    } else {
        if (typeSelect) typeSelect.value = '';
        if (typeGroup) typeGroup.classList.remove('d-none');
        if (titleEl) titleEl.textContent = 'Add Transaction';
        if (submitBtn) submitBtn.textContent = 'Add Transaction';
    }

    const locked = Boolean(fundId) && Boolean(symbol);
    categoryGroup.classList.toggle('d-none', locked);
    symbolGroup.classList.toggle('d-none', locked);

    if (context) context.classList.toggle('d-none', !locked);

    // Trigger previews to recalculate after programmatic value changes
    if (priceInput) priceInput.dispatchEvent(new Event('input'));
    if (quantityInput) quantityInput.dispatchEvent(new Event('input'));
    if (feesInput) feesInput.dispatchEvent(new Event('input'));
    if (typeSelect) typeSelect.dispatchEvent(new Event('change'));

    new bootstrap.Modal(modalEl).show();
}

function editTransaction(id, fundId, type, symbol, price, quantity, fees, notes, dateShort) {
    document.getElementById('editTransactionForm').action = `/transactions/edit/${id}`;

    function trimTrailingZeros(v) {
        if (v == null) return '';
        const s = String(v).trim();
        if (!s) return '';
        // Only operate on plain decimals; leave anything else to the generic normalizer.
        if (!/^[-+]?\d*(?:\.\d+)?$/.test(s)) return s;
        if (!s.includes('.')) return s;
        const out = s.replace(/(?:\.0+|(?<=\.\d*?)0+)$/, '');
        return out.endsWith('.') ? out.slice(0, -1) : out;
    }

    const categorySelect = document.getElementById('edit_fund_id_display');
    const typeSelect = document.getElementById('edit_transaction_type_display');
    const symbolInput = document.getElementById('edit_symbol');
    const priceInput = document.getElementById('edit_price');
    const quantityInput = document.getElementById('edit_quantity');
    const feesInput = document.getElementById('edit_fees');
    const notesInput = document.getElementById('edit_notes');
    const dateInput = document.getElementById('edit_date');

    if (categorySelect) categorySelect.value = fundId ? String(fundId) : '';
    if (typeSelect) typeSelect.value = type || '';
    if (symbolInput) symbolInput.value = (symbol || '').toUpperCase();
    if (priceInput) priceInput.value = trimTrailingZeros(price);
    if (quantityInput) quantityInput.value = trimTrailingZeros(quantity);
    if (feesInput) feesInput.value = fees;
    if (notesInput) notesInput.value = notes;
    if (dateInput) dateInput.value = dateShort || '';

    ensureEditDatePicker();

    // Context banner like Add (but always shown)
    const ctxValue = document.getElementById('edit_tx_context_value');
    const selectedCategoryText = categorySelect && categorySelect.selectedOptions && categorySelect.selectedOptions[0]
        ? categorySelect.selectedOptions[0].text
        : '';
    if (ctxValue) {
        const symbolText = (symbol || '').toUpperCase();
        ctxValue.textContent = selectedCategoryText ? (symbolText ? `${selectedCategoryText}/${symbolText}` : selectedCategoryText) : 'Edit Transaction';
    }

    // Trigger preview recalculation after programmatic value changes
    if (priceInput) priceInput.dispatchEvent(new Event('input'));
    if (quantityInput) quantityInput.dispatchEvent(new Event('input'));
    if (feesInput) feesInput.dispatchEvent(new Event('input'));
    if (typeSelect) typeSelect.dispatchEvent(new Event('change'));

    new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
}

// Setup delete transaction AJAX handler once
(function setupDeleteTransaction() {
    var form = document.getElementById('deleteTransactionForm');
    var errorDiv = document.getElementById('delete_tx_error');
    var submitBtn = form.querySelector('button[type="submit"]');
    var modalEl = document.getElementById('deleteTransactionModal');

    function showError(msg) {
        errorDiv.textContent = msg || 'Operation failed';
        errorDiv.classList.remove('d-none');
    }

    function hideError() {
        errorDiv.textContent = '';
        errorDiv.classList.add('d-none');
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (submitBtn.disabled) return;

        submitBtn.disabled = true;
        hideError();

        var xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.onload = function() {
            submitBtn.disabled = false;
            try {
                var data = JSON.parse(xhr.responseText);
                if (data.success) {
                    sessionStorage.setItem('flashMessage', data.message || 'Transaction deleted');
                    sessionStorage.setItem('flashType', 'success');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    location.reload();
                } else {
                    showError(data.error);
                }
            } catch (ex) {
                showError('Operation failed');
            }
        };
        xhr.onerror = function() {
            submitBtn.disabled = false;
            showError('Network error');
        };
        xhr.send(new FormData(form));
    });

    window.deleteTransaction = function(id) {
        form.action = '/transactions/delete/' + id;
        hideError();
        submitBtn.disabled = false;
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
    };
})();

// Setup delete asset AJAX handler once
(function setupDeleteAsset() {
    var form = document.getElementById('deleteAssetForm');
    var errorDiv = document.getElementById('delete_asset_error');
    var submitBtn = form.querySelector('button[type="submit"]');
    var modalEl = document.getElementById('deleteAssetModal');
    var fundInput = document.getElementById('delete_asset_fund_id');
    var symbolInput = document.getElementById('delete_asset_symbol');

    function showError(msg) {
        errorDiv.textContent = msg || 'Operation failed';
        errorDiv.classList.remove('d-none');
    }

    function hideError() {
        errorDiv.textContent = '';
        errorDiv.classList.add('d-none');
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (submitBtn.disabled) return;

        submitBtn.disabled = true;
        hideError();

        var xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.onload = function() {
            submitBtn.disabled = false;
            try {
                var data = JSON.parse(xhr.responseText);
                if (data.success) {
                    sessionStorage.setItem('flashMessage', data.message || 'Symbol deleted');
                    sessionStorage.setItem('flashType', 'success');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    location.reload();
                } else {
                    showError(data.error);
                }
            } catch (ex) {
                showError('Operation failed');
            }
        };
        xhr.onerror = function() {
            submitBtn.disabled = false;
            showError('Network error');
        };
        xhr.send(new FormData(form));
    });

    window.openDeleteAssetModal = function(fundId, categoryName, symbol, txCount) {
        if (fundInput) fundInput.value = fundId ? String(fundId) : '';
        if (symbolInput) symbolInput.value = (symbol || '').toUpperCase();
        hideError();
        submitBtn.disabled = false;
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
    };
})();

(function setupAddSellMax() {
    const modalEl = document.getElementById('addTransactionModal');
    const typeSelect = document.getElementById('transaction_type');
    const buyBtn = document.getElementById('add_tx_type_buy_btn');
    const sellBtn = document.getElementById('add_tx_type_sell_btn');
    const fundSelect = document.getElementById('fund_id');
    const symbolInput = document.getElementById('symbol');
    const quantityInput = document.getElementById('quantity');
    const maxRow = document.getElementById('add_sell_max_row');
    const maxBtn = document.getElementById('add_sell_max_btn');

    if (!modalEl || !typeSelect || !fundSelect || !symbolInput || !quantityInput || !maxRow || !maxBtn || !buyBtn || !sellBtn) return;

    let lastHeldQty = null;

    function setState({ visible, enabled, heldQty }) {
        maxRow.classList.toggle('d-none', !visible);
        maxBtn.disabled = !enabled;
        lastHeldQty = heldQty;
    }

    async function refresh() {
        const isSell = typeSelect.value === 'Sell';
        if (!isSell) {
            setState({ visible: false, enabled: false, heldQty: null });
            return;
        }

        const fundId = parseInt(fundSelect.value || '0', 10);
        const symbol = (symbolInput.value || '').trim().toUpperCase();

        if (!fundId || !symbol) {
            setState({ visible: true, enabled: false, heldQty: null });
            return;
        }

        setState({ visible: true, enabled: false, heldQty: null });

        try {
            const url = `/api/holdings?fund_id=${encodeURIComponent(String(fundId))}&symbol=${encodeURIComponent(symbol)}`;
            const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            const data = await resp.json();
            const heldQty = (data && data.held_quantity != null) ? String(data.held_quantity) : '0';
            const heldNum = parseFloat(heldQty);
            const enabled = Number.isFinite(heldNum) && heldNum > 0;
            setState({ visible: true, enabled, heldQty });
        } catch (e) {
            setState({ visible: true, enabled: false, heldQty: null });
        }
    }

    function setType(nextType) {
        typeSelect.value = nextType;
        typeSelect.dispatchEvent(new Event('change'));
    }

    function syncTypeButtons() {
        const isBuy = typeSelect.value === 'Buy';
        const isSell = typeSelect.value === 'Sell';

        buyBtn.classList.toggle('active', isBuy);
        sellBtn.classList.toggle('active', isSell);

        buyBtn.setAttribute('aria-pressed', isBuy ? 'true' : 'false');
        sellBtn.setAttribute('aria-pressed', isSell ? 'true' : 'false');

        modalEl.classList.toggle('tx-theme-buy', isBuy);
        modalEl.classList.toggle('tx-theme-sell', isSell);
    }

    maxBtn.addEventListener('click', function() {
        if (!lastHeldQty) return;
        quantityInput.value = lastHeldQty;
        quantityInput.dispatchEvent(new Event('input'));
    });

    buyBtn.addEventListener('click', function() {
        setType('Buy');
    });

    sellBtn.addEventListener('click', function() {
        setType('Sell');
    });

    typeSelect.addEventListener('change', function() {
        syncTypeButtons();
        refresh();
    });
    fundSelect.addEventListener('change', refresh);
    symbolInput.addEventListener('input', refresh);

    syncTypeButtons();

    refresh();
})();

// Ensure header action buttons don't trigger row expand/collapse.
(function wireHeaderActionButtons() {
    document.addEventListener('click', function(ev) {
        const editBtn = ev.target && ev.target.closest ? ev.target.closest('.js-edit-transaction-btn') : null;
        if (editBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

            try {
                const payload = editBtn.getAttribute('data-tx') || '{}';
                const tx = JSON.parse(payload);
                editTransaction(tx.id, tx.fundId, tx.type, tx.symbol, tx.price, tx.quantity, tx.fees, tx.notes, tx.dateShort);
            } catch (e) {
                // Fallback: do nothing (keeps page functional)
            }
            return;
        }

        const delTxBtn = ev.target && ev.target.closest ? ev.target.closest('.js-delete-transaction-btn') : null;
        if (delTxBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

            const id = parseInt(delTxBtn.getAttribute('data-tx-id') || '0', 10);
            if (id) deleteTransaction(id);
            return;
        }

        const addBtn = ev.target && ev.target.closest ? ev.target.closest('.js-add-transaction-btn') : null;
        if (addBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

            const fundId = parseInt(addBtn.getAttribute('data-fund-id') || '0', 10) || null;
            const category = addBtn.getAttribute('data-category') || '';
            const symbol = addBtn.getAttribute('data-symbol') || '';
            openAddTransactionModal(fundId, category, symbol);
            return;
        }

        const delBtn = ev.target && ev.target.closest ? ev.target.closest('.js-delete-symbol-btn') : null;
        if (delBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

            const fundId = parseInt(delBtn.getAttribute('data-fund-id') || '0', 10) || null;
            const category = delBtn.getAttribute('data-category') || '';
            const symbol = delBtn.getAttribute('data-symbol') || '';
            const txCount = parseInt(delBtn.getAttribute('data-tx-count') || '0', 10) || 0;
            openDeleteAssetModal(fundId, category, symbol, txCount);
        }
    }, true);
})();
</script>
{% endblock %}
