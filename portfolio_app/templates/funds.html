{% extends "base.html" %}

{% set _add_errs = (form_errors.get('funds_add', {}) if form_errors else {}) %}
{% set _add_vals = (form_values.get('funds_add', {}) if form_values else {}) %}
{% set _dep_errs = (form_errors.get('funds_deposit', {}) if form_errors else {}) %}
{% set _dep_vals = (form_values.get('funds_deposit', {}) if form_values else {}) %}
{% set _with_errs = (form_errors.get('funds_withdraw', {}) if form_errors else {}) %}
{% set _with_vals = (form_values.get('funds_withdraw', {}) if form_values else {}) %}
{% set _evt_errs = (form_errors.get('funds_event_edit', {}) if form_errors else {}) %}
{% set _evt_vals = (form_values.get('funds_event_edit', {}) if form_values else {}) %}

{% block title %}Funds - Investment Portfolio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Funds</h1>
            {% if available_categories|length > 0 %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFundEntryModal">
                Add Funds
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Funds by Asset Category (expandable history) -->
<div class="row">
    <div class="col-12">
        {% if funds_data|length > 0 %}
            {% for item in funds_data %}
            <div class="card border-0 shadow-sm mb-3">
                 <div class="card-header bg-white border-bottom py-2 px-3 category-header page-accent-surface"
                     onclick="toggleFundEvents('{{ item.group_id }}')">
                    <div class="row align-items-center g-1 summary-row">
                        <div class="col-lg-3 col-md-4 d-flex align-items-center gap-2">
                            <i class="bi bi-chevron-right category-chevron" id="fund-chevron-{{ item.group_id }}"></i>
                            <span class="text-dark">{{ item.fund.category }}</span>
                        </div>
                        <div class="col-lg-7 col-md-6">
                            <div class="category-summary columns-3">
                                <div class="summary-item">
                                    <div class="summary-label">Total Funds</div>
                                    <div class="summary-value">{{ item.fund.amount|fmt_money }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-2 text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success js-deposit-funds-btn"
                                        data-fund-id="{{ item.fund.id }}"
                                        data-category="{{ item.fund.category|e }}"
                                        title="Deposit"
                                        aria-label="Deposit"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top">
                                    <i class="bi bi-arrow-down-circle"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger js-withdraw-funds-btn"
                                        data-fund-id="{{ item.fund.id }}"
                                        data-category="{{ item.fund.category|e }}"
                                        title="Withdraw"
                                        aria-label="Withdraw"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top">
                                    <i class="bi bi-arrow-up-circle"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger js-delete-fund-btn"
                                        data-fund-id="{{ item.fund.id }}"
                                        data-category="{{ item.fund.category|e }}"
                                        title="Delete Asset Category"
                                        aria-label="Delete Asset Category"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="category-transactions" id="fund-events-{{ item.group_id }}" style="display: none;">
                    {% if item.events|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0 transactions-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 140px;">Date</th>
                                    <th class="text-end" style="width: 160px;">Funds</th>
                                    <th>Notes</th>
                                    <th class="text-center" style="width: 90px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for e in item.events %}
                                {% set display_notes = e.notes if e.notes and e.notes != 'Backfilled from existing funds' else None %}
                                <tr>
                                    <td><small class="text-muted">{{ e.date_short }}</small></td>
                                    <td class="text-end">
                                        <small class="{% if e.event_type == 'Withdrawal' %}text-danger{% endif %}">
                                            {{ e.amount_delta|fmt_money }}
                                        </small>
                                    </td>
                                    <td><small class="text-muted">{{ display_notes or 'N/A' }}</small></td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm js-edit-fund-event-btn"
                                                    data-event='{{ {
                                                        "id": e.id,
                                                        "type": e.event_type,
                                                        "amount": e.amount_delta,
                                                        "notes": (display_notes or ""),
                                                        "dateShort": e.date_short
                                                    }|tojson|e }}'
                                                    title="Edit"
                                                    aria-label="Edit"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm js-delete-fund-event-btn"
                                                    data-event-id="{{ e.id }}"
                                                    title="Delete"
                                                    aria-label="Delete"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-3 text-center help-message page-accent-surface">
                        <button type="button" class="btn btn-outline-success btn-sm js-deposit-funds-btn"
                                data-fund-id="{{ item.fund.id }}"
                                data-category="{{ item.fund.category|e }}">
                            <i class="bi bi-arrow-down-circle"></i> Deposit
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i>
                    No funds entries found. Add funds to get started.
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Deposit Funds Modal -->
<div class="modal fade" id="addFundsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="addFundsForm" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Asset Category</label>
                        <input type="text" class="form-control" id="add_funds_category" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="add_funds_amount" class="form-label">Amount</label>
                           {% set _dep_errs = (form_errors.get('funds_deposit', {}) if form_errors else {}) %}
                           {% set _dep_vals = (form_values.get('funds_deposit', {}) if form_values else {}) %}
                           <input type="text" inputmode="decimal" class="form-control {% if _dep_errs.get('amount_delta') %}is-invalid{% endif %}" id="add_funds_amount" name="amount_delta"
                               placeholder="0.00"
                               value="{{ _dep_vals.get('amount_delta', '') }}">
                           {% if _dep_errs.get('amount_delta') %}
                           <div class="invalid-feedback">{{ _dep_errs.get('amount_delta') }}</div>
                           {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="add_funds_notes" class="form-label">Notes (optional)</label>
                           <input type="text" class="form-control" id="add_funds_notes" name="notes" maxlength="200" placeholder="e.g., monthly top-up"
                               value="{{ _dep_vals.get('notes', '') }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Deposit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Withdraw Funds Modal -->
<div class="modal fade" id="withdrawFundsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="withdrawFundsForm" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Withdraw</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Asset Category</label>
                        <input type="text" class="form-control" id="withdraw_funds_category" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="withdraw_funds_amount" class="form-label">Amount</label>
                           {% set _with_errs = (form_errors.get('funds_withdraw', {}) if form_errors else {}) %}
                           {% set _with_vals = (form_values.get('funds_withdraw', {}) if form_values else {}) %}
                           <input type="text" inputmode="decimal" class="form-control {% if _with_errs.get('amount_delta') %}is-invalid{% endif %}" id="withdraw_funds_amount" name="amount_delta"
                               placeholder="0.00"
                               value="{{ _with_vals.get('amount_delta', '') }}">
                           {% if _with_errs.get('amount_delta') %}
                           <div class="invalid-feedback">{{ _with_errs.get('amount_delta') }}</div>
                           {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="withdraw_funds_notes" class="form-label">Notes (optional)</label>
                           <input type="text" class="form-control" id="withdraw_funds_notes" name="notes" maxlength="200" placeholder="e.g., rebalance / cash out"
                               value="{{ _with_vals.get('notes', '') }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Withdraw</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Funds Entry Modal (new asset category) -->
<div class="modal fade" id="addFundEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('funds.funds_add') }}" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Funds</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category" class="form-label">Asset Category</label>
                        {% set _add_errs = (form_errors.get('funds_add', {}) if form_errors else {}) %}
                        {% set _add_vals = (form_values.get('funds_add', {}) if form_values else {}) %}
                        <select class="form-select {% if _add_errs.get('category') %}is-invalid{% endif %}" id="category" name="category">
                            <option value="">Select asset category...</option>
                            {% for cat in available_categories %}
                            <option value="{{ cat }}" {% if _add_vals.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                        {% if _add_errs.get('category') %}
                        <div class="invalid-feedback">{{ _add_errs.get('category') }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                           <input type="text" inputmode="decimal" class="form-control {% if _add_errs.get('amount') %}is-invalid{% endif %}" id="amount" name="amount"
                               placeholder="0.00"
                               value="{{ _add_vals.get('amount', '') }}">
                        {% if _add_errs.get('amount') %}
                        <div class="invalid-feedback">{{ _add_errs.get('amount') }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Fund Event Modal -->
<div class="modal fade" id="editFundEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editFundEventForm" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-control" id="edit_event_type" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit_event_date" class="form-label">Date</label>
                           {% set _evt_errs = (form_errors.get('funds_event_edit', {}) if form_errors else {}) %}
                           {% set _evt_vals = (form_values.get('funds_event_edit', {}) if form_values else {}) %}
                           <input type="text" class="form-control {% if _evt_errs.get('date') %}is-invalid{% endif %}" id="edit_event_date" name="date" placeholder="YYYY-MM-DD"
                               value="{{ _evt_vals.get('date', '') }}">
                           {% if _evt_errs.get('date') %}
                           <div class="invalid-feedback">{{ _evt_errs.get('date') }}</div>
                           {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="edit_event_amount" class="form-label">Amount</label>
                           <input type="text" inputmode="decimal" class="form-control {% if _evt_errs.get('edit_event_amount') %}is-invalid{% endif %}" id="edit_event_amount" name="edit_event_amount"
                               placeholder="0.00"
                               value="{{ _evt_vals.get('edit_event_amount', '') }}">
                           {% if _evt_errs.get('edit_event_amount') %}
                           <div class="invalid-feedback">{{ _evt_errs.get('edit_event_amount') }}</div>
                           {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="edit_event_notes" class="form-label">Notes (optional)</label>
                           <input type="text" class="form-control" id="edit_event_notes" name="edit_event_notes" maxlength="200"
                               value="{{ _evt_vals.get('edit_event_notes', '') }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Fund Event Modal -->
<div class="modal fade" id="deleteFundEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="deleteFundEventForm" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Delete this event?</p>
                    {% set _del_evt_err = (form_errors.get('funds_event_delete') or {}).get('__all__') if form_errors else None %}
                    {% if _del_evt_err %}
                        <div class="invalid-feedback d-block">{{ _del_evt_err }}</div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Fund Modal -->
<div class="modal fade" id="deleteFundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="deleteFundForm" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Delete funds entry for <strong id="delete_category_name"></strong>?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        This also deletes all related transactions.
                    </div>
                    {% set _del_fund_err = (form_errors.get('funds_delete') or {}).get('__all__') if form_errors else None %}
                    {% if _del_fund_err %}
                        <div class="invalid-feedback d-block">{{ _del_fund_err }}</div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script>
function ensureFundEventDatePicker() {
    const el = document.getElementById('edit_event_date');
    if (!el) return;
    if (el._flatpickr) return;
    if (!window.flatpickr) return;

    window.flatpickr(el, {
        dateFormat: 'Y-m-d',
        allowInput: true,
    });
}

function displayEventType(eventType) {
    const map = {
        'Deposit': 'Deposit',
        'Withdrawal': 'Withdrawal',
        'Initial': 'Initial'
    };
    return map[eventType] || eventType || '';
}

function toggleFundEvents(groupId) {
    const eventsDiv = document.getElementById(`fund-events-${groupId}`);
    const chevron = document.getElementById(`fund-chevron-${groupId}`);
    if (!eventsDiv || !chevron) return;

    if (eventsDiv.style.display === 'none') {
        eventsDiv.style.display = 'block';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
    } else {
        eventsDiv.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
    }
}

function depositFunds(id, category, opts) {
    opts = opts || {};
    document.getElementById('addFundsForm').action = `/funds/deposit/${id}`;
    document.getElementById('add_funds_category').value = category || '';
    document.getElementById('add_funds_amount').value = (opts.amount != null ? String(opts.amount) : '');
    document.getElementById('add_funds_notes').value = (opts.notes != null ? String(opts.notes) : '');
    new bootstrap.Modal(document.getElementById('addFundsModal')).show();
}

function withdrawFunds(id, category, opts) {
    opts = opts || {};
    document.getElementById('withdrawFundsForm').action = `/funds/withdraw/${id}`;
    document.getElementById('withdraw_funds_category').value = category || '';
    document.getElementById('withdraw_funds_amount').value = (opts.amount != null ? String(opts.amount) : '');
    document.getElementById('withdraw_funds_notes').value = (opts.notes != null ? String(opts.notes) : '');
    new bootstrap.Modal(document.getElementById('withdrawFundsModal')).show();
}

function editFundEvent(eventId, eventType, amountDelta, notes, dateShort) {
    document.getElementById('editFundEventForm').action = `/funds/events/edit/${eventId}`;
    document.getElementById('edit_event_type').value = displayEventType(eventType);
    document.getElementById('edit_event_date').value = dateShort || '';
    document.getElementById('edit_event_amount').value = Math.abs(parseFloat(amountDelta || 0)).toFixed(2);
    document.getElementById('edit_event_notes').value = notes || '';
    ensureFundEventDatePicker();
    new bootstrap.Modal(document.getElementById('editFundEventModal')).show();
}

// Re-open a modal after server-side validation errors (no browser/JS validation).
(function reopenModalFromServerErrors() {
    const which = {{ (open_modal or '') | tojson }};
    const payload = {{ (open_modal_payload or {}) | tojson }};

    if (!which) return;

    document.addEventListener('DOMContentLoaded', function() {
        try {
            if (which === 'addFundsModal' && payload && payload.fund_id) {
                depositFunds(payload.fund_id, payload.category || '', {
                    amount: {{ (_dep_vals.get('amount_delta', '') if form_values and form_values.get('funds_deposit') else '') | tojson }},
                    notes: {{ (_dep_vals.get('notes', '') if form_values and form_values.get('funds_deposit') else '') | tojson }},
                });
            }
            if (which === 'withdrawFundsModal' && payload && payload.fund_id) {
                withdrawFunds(payload.fund_id, payload.category || '', {
                    amount: {{ (_with_vals.get('amount_delta', '') if form_values and form_values.get('funds_withdraw') else '') | tojson }},
                    notes: {{ (_with_vals.get('notes', '') if form_values and form_values.get('funds_withdraw') else '') | tojson }},
                });
            }
            if (which === 'addFundEntryModal') {
                new bootstrap.Modal(document.getElementById('addFundEntryModal')).show();
            }
            if (which === 'editFundEventModal' && payload && payload.event_id) {
                editFundEvent(
                    payload.event_id,
                    payload.event_type || '',
                    {{ (_evt_vals.get('edit_event_amount', '') if form_values and form_values.get('fund_event_edit') else '') | tojson }},
                    {{ (_evt_vals.get('edit_event_notes', '') if form_values and form_values.get('fund_event_edit') else '') | tojson }},
                    {{ (_evt_vals.get('date', '') if form_values and form_values.get('fund_event_edit') else '') | tojson }},
                );
            }

            if (which === 'deleteFundEventModal' && payload && payload.event_id) {
                deleteFundEvent(payload.event_id);
            }

            if (which === 'deleteFundModal' && payload && payload.fund_id) {
                deleteFund(payload.fund_id, payload.category || '');
            }
        } catch (e) {
            // noop
        }
    });
})();

function deleteFundEvent(eventId) {
    document.getElementById('deleteFundEventForm').action = `/funds/events/delete/${eventId}`;
    new bootstrap.Modal(document.getElementById('deleteFundEventModal')).show();
}

function deleteFund(id, category) {
    document.getElementById('deleteFundForm').action = `/funds/delete/${id}`;
    document.getElementById('delete_category_name').textContent = category || '';
    new bootstrap.Modal(document.getElementById('deleteFundModal')).show();
}

(function wireFundsActionButtons() {
    document.addEventListener('click', function(ev) {
        const depositBtn = ev.target && ev.target.closest ? ev.target.closest('.js-deposit-funds-btn') : null;
        if (depositBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
            const fundId = parseInt(depositBtn.getAttribute('data-fund-id') || '0', 10);
            const category = depositBtn.getAttribute('data-category') || '';
            if (fundId) depositFunds(fundId, category);
            return;
        }

        const withdrawBtn = ev.target && ev.target.closest ? ev.target.closest('.js-withdraw-funds-btn') : null;
        if (withdrawBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
            const fundId = parseInt(withdrawBtn.getAttribute('data-fund-id') || '0', 10);
            const category = withdrawBtn.getAttribute('data-category') || '';
            if (fundId) withdrawFunds(fundId, category);
            return;
        }

        const deleteFundBtn = ev.target && ev.target.closest ? ev.target.closest('.js-delete-fund-btn') : null;
        if (deleteFundBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
            const fundId = parseInt(deleteFundBtn.getAttribute('data-fund-id') || '0', 10);
            const category = deleteFundBtn.getAttribute('data-category') || '';
            if (fundId) deleteFund(fundId, category);
            return;
        }

        const editEventBtn = ev.target && ev.target.closest ? ev.target.closest('.js-edit-fund-event-btn') : null;
        if (editEventBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
            try {
                const data = JSON.parse(editEventBtn.getAttribute('data-event') || '{}');
                editFundEvent(data.id, data.type, data.amount, data.notes, data.dateShort);
            } catch (e) {
                // noop
            }
            return;
        }

        const deleteEventBtn = ev.target && ev.target.closest ? ev.target.closest('.js-delete-fund-event-btn') : null;
        if (deleteEventBtn) {
            ev.preventDefault();
            ev.stopPropagation();
            if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
            const eventId = parseInt(deleteEventBtn.getAttribute('data-event-id') || '0', 10);
            if (eventId) deleteFundEvent(eventId);
        }
    }, true);
})();
</script>
{% endblock %}
