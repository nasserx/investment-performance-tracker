{% extends 'base.html' %}

{% block title %}Admin — User Management{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="mb-1" style="font-size:1.4rem; font-weight:500;">
        <i class="bi bi-shield-check me-2 text-primary"></i>User Management
    </h2>
    <p class="text-muted mb-0" style="font-size:0.875rem;">
        {{ users|length }} registered user{{ 's' if users|length != 1 else '' }}
    </p>
</div>

{% if users %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-light">
            <tr>
                <th style="width:40px;">#</th>
                <th>Username</th>
                <th>Role</th>
                <th>Registered</th>
                <th>Last Login</th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td class="text-muted" style="font-size:0.8125rem;">{{ user.id }}</td>
                <td>
                    <span class="fw-500">{{ user.username }}</span>
                    {% if user.id == current_user.id %}
                        <span class="badge bg-primary ms-1" style="font-size:0.7rem;">You</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_admin %}
                        <span class="badge" style="background:var(--primary-lighter); color:var(--primary-color); font-size:0.75rem;">
                            <i class="bi bi-shield-fill me-1"></i>Admin
                        </span>
                    {% else %}
                        <span class="badge" style="background:var(--surface-variant); color:var(--text-secondary); font-size:0.75rem;">
                            User
                        </span>
                    {% endif %}
                </td>
                <td class="text-muted" style="font-size:0.875rem;">
                    {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '—' }}
                </td>
                <td class="text-muted" style="font-size:0.875rem;">
                    {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}
                </td>
                <td class="text-end">
                    <div class="d-flex gap-2 justify-content-end">

                        <!-- Reset Password -->
                        <form method="post"
                              action="{{ url_for('admin.reset_password', user_id=user.id) }}"
                              onsubmit="return confirm('Reset password for {{ user.username }}? A temporary password will be shown.')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Reset Password">
                                <i class="bi bi-key"></i>
                            </button>
                        </form>

                        <!-- Toggle Admin (cannot change own) -->
                        {% if user.id != current_user.id %}
                        <form method="post"
                              action="{{ url_for('admin.toggle_admin', user_id=user.id) }}"
                              onsubmit="return confirm('{{ 'Revoke' if user.is_admin else 'Grant' }} admin access for {{ user.username }}?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit"
                                    class="btn btn-sm {{ 'btn-outline-danger' if user.is_admin else 'btn-outline-primary' }}"
                                    title="{{ 'Revoke Admin' if user.is_admin else 'Grant Admin' }}">
                                <i class="bi {{ 'bi-shield-x' if user.is_admin else 'bi-shield-plus' }}"></i>
                            </button>
                        </form>

                        <!-- Delete user -->
                        <form method="post"
                              action="{{ url_for('admin.delete_user', user_id=user.id) }}"
                              onsubmit="return confirm('Delete user {{ user.username }}? This cannot be undone.')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete User">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}

                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
    <div class="alert alert-info">No users found.</div>
{% endif %}

<!-- Help note -->
<div class="mt-3">
    <p class="text-muted" style="font-size:0.8125rem;">
        <i class="bi bi-info-circle me-1"></i>
        When you reset a password, a temporary 12-character password will be shown in a success message.
        Share it with the user — they should change it immediately.
    </p>
</div>
{% endblock %}
